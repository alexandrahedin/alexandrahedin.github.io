---
import Layout from './Layout.astro';
import Biography from '../components/content-sections/Biography.astro';
import Contact from '../components/content-sections/Contact.astro';
import Listen from '../components/content-sections/Listen.astro';
import Photo from '../components/content-sections/Photo.astro';
import Upcoming from '../components/content-sections/Upcoming.astro';
import Header from '../components/parts/Header.astro';
import Footer from '../components/parts/Footer.astro';
import { getPageData } from '../lib/pageUtils';

export interface Props {
  lang: "en" | "sv";
  skipVideosText: string;
  playVideoText: string;
  skipGalleryText: string;
}

const { lang, skipVideosText, playVideoText, skipGalleryText } = Astro.props;

// Get all page data
const { settings, events, bio, video, gallery, upcoming, contact } = await getPageData(lang);

// Import all gallery images
const galleryImages = import.meta.glob<{ default: ImageMetadata }>('../assets/gallery/*.jpg', { eager: true });

const galleryItems = (gallery?.data?.items || [])
  .map(item => {
    const imagePath = `../assets/gallery/${item.image}`;
    const image = galleryImages[imagePath]?.default;
    if (!image) {
      console.warn(`Image not found: ${imagePath}`);
    }
    return {
      title: item.title,
      image: image,
      caption: item.caption,
    };
  })
  .filter(item => item.image !== undefined);

// Build navigation items from content sections
const navItems = [
    { href: `#${bio.entry?.data?.sectionId || ''}`, text: bio.entry?.data?.navText || '' },
    { href: `#${video.entry?.data?.sectionId || ''}`, text: video.entry?.data?.navText || '' },
    { href: `#${gallery?.data?.sectionId || ''}`, text: gallery?.data?.navText || '' },
    { href: `#${contact?.data?.sectionId || ''}`, text: contact?.data?.navText || '' },
];

// Add upcoming as the first item of the navItems array if there are events.
if (events.length > 0) {
    navItems.unshift({ href: `#${upcoming?.data?.sectionId || ''}`, text: upcoming?.data?.navText || '' });
}

const showBioHeaderImage = events.length > 0;
---

<Layout
	title={settings.pageTitle}
	lang={lang}
	metaDescription={settings.metaDescription}
	posthogId={settings.posthogId}
>
    <Header
        mainTitle={settings.mainTitle}
        subTitle={settings.subTitle}
        navItems={navItems}
    />
	<main>
        <Upcoming
            title={upcoming?.data?.title || ''}
            sectionId={upcoming?.data?.sectionId || ''}
            events={events}
        />

        <Biography title={bio.entry?.data?.title || ''} sectionId={bio.entry?.data?.sectionId || ''} showHeaderImage={showBioHeaderImage} quotes={bio.entry?.data?.quotes || []}>
          {bio.content && <bio.content />}
        </Biography>

		<Listen title={video.entry?.data?.title || ''} sectionId={video.entry?.data?.sectionId || ''} skipLinkText={skipVideosText} playVideoLabel={playVideoText} videos={video.items} />

        <Photo title={gallery?.data?.title || ''} sectionId={gallery?.data?.sectionId || ''} galleryTitle={gallery?.data?.galleryTitle || ''} skipLinkText={skipGalleryText} galleryItems={galleryItems} />

        <Contact 
            title={contact?.data?.title || ''}
            sectionId={contact?.data?.sectionId || ''}
            emailTitle={contact?.data?.emailTitle || ''}
            emailHref={contact?.data?.emailHref || ''}
            emailText={contact?.data?.emailText || ''}
            phoneTitle={contact?.data?.phoneTitle || ''}
            phoneHref={contact?.data?.phoneHref || ''}
            phoneText={contact?.data?.phoneText || ''}
        />
	</main>
    <Footer navItems={navItems} />
</Layout>
