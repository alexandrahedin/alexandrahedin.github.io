---
import { getEntry, getCollection } from "astro:content";

import Layout from '../layouts/Layout.astro';
import Biography from '../components/content-sections/Biography.astro';
import Contact from '../components/content-sections/Contact.astro';
import Listen from '../components/content-sections/Listen.astro';
import Photo from '../components/content-sections/Photo.astro';
import Upcoming from '../components/content-sections/Upcoming.astro';
import Header from '../components/parts/Header.astro';
import Footer from '../components/parts/Footer.astro';

const lang = "en";

// Load settings for this language
const allSettingsEntries = await getCollection("settings");
const settingsEntry = allSettingsEntries.find(e => e.id === `settings.${lang}.md`);

const pageTitle = settingsEntry?.data?.pageTitle || '';
const metaDescription = settingsEntry?.data?.metaDescription || '';
const mainTitle = settingsEntry?.data?.headerMainTitle || '';
const subTitle = settingsEntry?.data?.headerSubtitle || '';

// Load all events for this language
const allEvents = await getCollection("events", ({ id }) => {
  return id.endsWith(`.${lang}.md`);
});

const rawEvents = allEvents.map((event) => event.data);

const now = new Date();

const cmsEvents = rawEvents
  .filter((event) => {
    // Show if alwaysShow is true, or if the event is in the future
    if (event.alwaysShow) return true;
    
    // Combine date and time to create a full datetime
    const dateTimeString = event.time ? `${event.date}T${event.time}` : event.date;
    return new Date(dateTimeString) >= now;
  })
  .sort(
    (a, b) => {
      const aDateTime = a.time ? `${a.date}T${a.time}` : a.date;
      const bDateTime = b.time ? `${b.date}T${b.time}` : b.date;
      return new Date(aDateTime).getTime() - new Date(bDateTime).getTime();
    }
  );

function getOrdinal(day: number) {
  if (day > 3 && day < 21) return "th";
  switch (day % 10) {
    case 1:
      return "st";
    case 2:
      return "nd";
    case 3:
      return "rd";
    default:
      return "th";
  }
}

const events = cmsEvents.map((event) => {
  const dateTimeString = event.time ? `${event.date}T${event.time}` : event.date;
  const date = new Date(dateTimeString);

  const weekday = date.toLocaleDateString("en-US", {
    weekday: "long",
  });

  const month = date.toLocaleDateString("en-US", {
    month: "long",
  });

  const day = date.getDate();
  const ordinal = getOrdinal(day);

  const time = event.time || date.toLocaleTimeString("en-US", {
    hour: "2-digit",
    minute: "2-digit",
    hour12: false,
  });

  return {
    ...event,
    date: `${weekday}, ${month} ${day}${ordinal} at ${time}`,
  };
});

const allBioEntries = await getCollection("biography");
const bioEntry = allBioEntries.find(e => e.id === `biography.${lang}.md`);

const { Content: BioContent } = bioEntry ? await bioEntry.render() : { Content: null };

// Load videos for this language
const allVideoEntries = await getCollection("videos");
const videoEntry = allVideoEntries.find(e => e.id === `videos.${lang}.md`);

const videoItems = videoEntry?.data?.items
  ?.filter(item => !item.hidden)
  .map(item => ({
    title: item.title,
    vimeoId: item.vimeoId.toString(),
    customContainerStyle: item.customContainerStyle || '',
  })) || [];

// Load gallery for this language
const allGalleryEntries = await getCollection("gallery");
const galleryEntry = allGalleryEntries.find(e => e.id === `gallery.${lang}.md`);

// Import all gallery images
const galleryImages = import.meta.glob<{ default: ImageMetadata }>('../assets/gallery/*.jpg', { eager: true });

const galleryItems = (galleryEntry?.data?.items || [])
  .map(item => {
    const imagePath = `../assets/gallery/${item.image}`;
    const image = galleryImages[imagePath]?.default;
    if (!image) {
      console.warn(`Image not found: ${imagePath}`);
    }
    return {
      title: item.title,
      image: image,
      caption: item.caption,
    };
  })
  .filter(item => item.image !== undefined);

const navItems = [
    { href: '#biography', text: 'Biography' },
    { href: '#listen', text: 'Listen' },
    { href: '#photo', text: 'Photo' },
    { href: '#contact', text: 'Contact' },
]

// Add upcoming as the first item of the navItems array if there are events.
if (events.length > 0) {
    navItems.unshift({ href: '#upcoming', text: 'Upcoming' });
}

const showBioHeaderImage = events.length > 0;

---

<Layout
	title={pageTitle}
	lang='en'
	metaDescription={metaDescription}
	posthogId={settingsEntry?.data?.posthogId}
>
    <Header
        mainTitle={mainTitle}
        subTitle={subTitle}
        navItems={navItems}
    />
	<main>
        <Upcoming
            title='Upcoming'
            events={events}
        />

    <Biography title={bioEntry?.data?.title || 'Biography' } showHeaderImage={showBioHeaderImage} quotes={bioEntry?.data?.quotes || []}>
      {BioContent && <BioContent />}
    </Biography>

		<Listen title='Listen' skipLinkText='Skip videos' playVideoLabel='Play video' videos={videoItems} />

        <Photo title='Photo' galleryTitle='Gallery' skipLinkText='Skip gallery' galleryItems={galleryItems} />

        <Contact title='Contact' emailTitle='Email' phoneTitle='Telephone' />
	</main>
    <Footer navItems={navItems} />
</Layout>
