---
import { getEntry, getCollection } from "astro:content";

import Layout from '../../layouts/Layout.astro';
import Quotes from '../../components/Quotes.astro';
import Biography from '../../components/content-sections/Biography.astro';
import Contact from '../../components/content-sections/Contact.astro';
import Listen from '../../components/content-sections/Listen.astro';
import Photo from '../../components/content-sections/Photo.astro';
import Upcoming from '../../components/content-sections/Upcoming.astro';
import Header from '../../components/parts/Header.astro';
import Footer from '../../components/parts/Footer.astro';

const lang = "sv";

const mainTitle = 'Alexandra Hedin';
const subTitle = 'Sopran';

// Load all events for this language
const allEvents = await getCollection("events", ({ id }) => {
  return id.endsWith(`.${lang}.md`);
});

const rawEvents = allEvents.map((event) => event.data);

const now = new Date();

const cmsEvents = rawEvents
  .filter((event) => {
    // Show if alwaysShow is true, or if the event is in the future
    if (event.alwaysShow) return true;
    
    // Combine date and time to create a full datetime
    const dateTimeString = event.time ? `${event.date}T${event.time}` : event.date;
    return new Date(dateTimeString) >= now;
  })
  .sort(
    (a, b) => {
      const aDateTime = a.time ? `${a.date}T${a.time}` : a.date;
      const bDateTime = b.time ? `${b.date}T${b.time}` : b.date;
      return new Date(aDateTime).getTime() - new Date(bDateTime).getTime();
    }
  );

const events = cmsEvents.map((event) => {
  const dateTimeString = event.time ? `${event.date}T${event.time}` : event.date;
  const date = new Date(dateTimeString);

  const weekday = date.toLocaleDateString("sv-SE", {
    weekday: "long",
  });

  const day = date.getDate();

  const month = date.toLocaleDateString("sv-SE", {
    month: "long",
  });

  const time = event.time || date
    .toLocaleTimeString("sv-SE", {
      hour: "2-digit",
      minute: "2-digit",
      hour12: false,
    })
    .replace(":", ".");

  return {
    ...event,
    date: `${capitalize(weekday)} ${day} ${month} kl ${time}`,
  };
});

function capitalize(value: string) {
  return value.charAt(0).toUpperCase() + value.slice(1);
}

const navItems = [
    { href: '#biografi', text: 'Biografi' },
    { href: '#lyssna', text: 'Lyssna' },
    { href: '#foto', text: 'Foto' },
    { href: '#kontakt', text: 'Kontakt' },
]

// Add upcoming as the first item of the navItems array if there are events.
if (events.length > 0) {
    navItems.unshift({ href: '#aktuellt', text: 'Aktuellt' });
}

const allBioEntries = await getCollection("biography");
const bioEntry = allBioEntries.find(e => e.id === `biography.${lang}.md`);

const { Content: BioContent } = bioEntry ? await bioEntry.render() : { Content: null };

// Load all gallery items for this language
const allGalleryItems = await getCollection("gallery", ({ id }) => {
  return id.endsWith(`.${lang}.md`);
});

// Import all gallery images
const galleryImages = import.meta.glob<{ default: ImageMetadata }>('../../assets/gallery/*.jpg', { eager: true });

const galleryItems = allGalleryItems
  .sort((a, b) => a.data.order - b.data.order)
  .map(item => {
    const imagePath = `../../assets/gallery/${item.data.image}`;
    const image = galleryImages[imagePath]?.default;
    if (!image) {
      console.warn(`Image not found: ${imagePath}`);
    }
    return {
      title: item.data.title,
      image: image,
      caption: item.data.caption,
    };
  })
  .filter(item => item.image !== undefined);

const showBioHeaderImage = events.length > 0;

const bioQuotes = [
    {
        text: '…med en röstkvalitet som är sensationellt bra. Alldeles raffinerad var hennes “Porgi amor” med en timbre som fick mig att tänka på en ung Gundula Janowitz. Även “Dove sono” sjöng hon utmärkt…',
        author: 'Sören Tranberg, Tidsskriften Opera',
    },
    {
        text: '…för kvällens vackraste röst utnämner jag Alexandra Hedin som gestaltade grevinnan, Rosina. När hon sjöng sin stora aria höll jag nästan andan för att inte missa något av den vokala upplevelsen!',
        author: 'Mogens H Andersson, Operalogg',
    },
    {
        text: 'Micaela som sjöngs av sopranen Alexandra Hedin krävde föreställningens första bravo-rop, vilket var helt välförtjänt!',
        author: 'Mogens H Andersson, Operalogg'
    }
];

---

<Layout
	title='Alexandra Hedin'
	lang='sv'
	metaDescription='Sopran Alexandra Hedin'
>
    <Header
        mainTitle={mainTitle}
        subTitle={subTitle}
        navItems={navItems}
    />
	<main>
        <Upcoming
            title='Aktuellt'
            events={events}
        />


        <Biography title={bioEntry?.data?.title || 'Biografi' } showHeaderImage={showBioHeaderImage}>
          {BioContent && <BioContent />}

          <Quotes quotes={bioQuotes} />
        </Biography>

		<Listen title='Lyssna' skipLinkText='Hoppa över videor' playVideoLabel='Spela video' />

        <Photo title='Foto' galleryTitle='Bildgalleri' skipLinkText='Hoppa över galleri' galleryItems={galleryItems} />

        <Contact title='Kontakt' emailTitle='E-mail' phoneTitle='Telefon' />
	</main>
    <Footer navItems={navItems} />
</Layout>
