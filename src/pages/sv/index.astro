---
import { getEntry, getCollection } from "astro:content";

import Layout from '../../layouts/Layout.astro';
import Biography from '../../components/content-sections/Biography.astro';
import Contact from '../../components/content-sections/Contact.astro';
import Listen from '../../components/content-sections/Listen.astro';
import Photo from '../../components/content-sections/Photo.astro';
import Upcoming from '../../components/content-sections/Upcoming.astro';
import Header from '../../components/parts/Header.astro';
import Footer from '../../components/parts/Footer.astro';

const lang = "sv";

// Load settings for this language
const allSettingsEntries = await getCollection("settings");
const settingsEntry = allSettingsEntries.find(e => e.id === `settings.${lang}.md`);

const pageTitle = settingsEntry?.data?.pageTitle || '';
const metaDescription = settingsEntry?.data?.metaDescription || '';
const mainTitle = settingsEntry?.data?.headerMainTitle || '';
const subTitle = settingsEntry?.data?.headerSubtitle || '';

// Load all events for this language
const allEvents = await getCollection("events", ({ id }) => {
  return id.endsWith(`.${lang}.md`);
});

const rawEvents = allEvents.map((event) => event.data);

const now = new Date();

const cmsEvents = rawEvents
  .filter((event) => {
    // Show if alwaysShow is true, or if the event is in the future
    if (event.alwaysShow) return true;
    
    // Combine date and time to create a full datetime
    const dateTimeString = event.time ? `${event.date}T${event.time}` : event.date;
    return new Date(dateTimeString) >= now;
  })
  .sort(
    (a, b) => {
      const aDateTime = a.time ? `${a.date}T${a.time}` : a.date;
      const bDateTime = b.time ? `${b.date}T${b.time}` : b.date;
      return new Date(aDateTime).getTime() - new Date(bDateTime).getTime();
    }
  );

const events = cmsEvents.map((event) => {
  const dateTimeString = event.time ? `${event.date}T${event.time}` : event.date;
  const date = new Date(dateTimeString);

  const weekday = date.toLocaleDateString("sv-SE", {
    weekday: "long",
  });

  const day = date.getDate();

  const month = date.toLocaleDateString("sv-SE", {
    month: "long",
  });

  const time = event.time || date
    .toLocaleTimeString("sv-SE", {
      hour: "2-digit",
      minute: "2-digit",
      hour12: false,
    })
    .replace(":", ".");

  return {
    ...event,
    date: `${capitalize(weekday)} ${day} ${month} kl ${time}`,
  };
});

function capitalize(value: string) {
  return value.charAt(0).toUpperCase() + value.slice(1);
}

const navItems = [
    { href: '#biografi', text: 'Biografi' },
    { href: '#lyssna', text: 'Lyssna' },
    { href: '#foto', text: 'Foto' },
    { href: '#kontakt', text: 'Kontakt' },
]

// Add upcoming as the first item of the navItems array if there are events.
if (events.length > 0) {
    navItems.unshift({ href: '#aktuellt', text: 'Aktuellt' });
}

const allBioEntries = await getCollection("biography");
const bioEntry = allBioEntries.find(e => e.id === `biography.${lang}.md`);

const { Content: BioContent } = bioEntry ? await bioEntry.render() : { Content: null };

// Load videos for this language
const allVideoEntries = await getCollection("videos");
const videoEntry = allVideoEntries.find(e => e.id === `videos.${lang}.md`);

const videoItems = videoEntry?.data?.items
  ?.filter(item => !item.hidden)
  .map(item => ({
    title: item.title,
    vimeoId: item.vimeoId.toString(),
    customContainerStyle: item.customContainerStyle || '',
  })) || [];

// Load gallery for this language
const allGalleryEntries = await getCollection("gallery");
const galleryEntry = allGalleryEntries.find(e => e.id === `gallery.${lang}.md`);

// Import all gallery images
const galleryImages = import.meta.glob<{ default: ImageMetadata }>('../../assets/gallery/*.jpg', { eager: true });

const galleryItems = (galleryEntry?.data?.items || [])
  .map(item => {
    const imagePath = `../../assets/gallery/${item.image}`;
    const image = galleryImages[imagePath]?.default;
    if (!image) {
      console.warn(`Image not found: ${imagePath}`);
    }
    return {
      title: item.title,
      image: image,
      caption: item.caption,
    };
  })
  .filter(item => item.image !== undefined);

const showBioHeaderImage = events.length > 0;


---

<Layout
	title={pageTitle}
	lang='sv'
	metaDescription={metaDescription}
	posthogId={settingsEntry?.data?.posthogId}
>
    <Header
        mainTitle={mainTitle}
        subTitle={subTitle}
        navItems={navItems}
    />
	<main>
        <Upcoming
            title='Aktuellt'
            events={events}
        />


        <Biography title={bioEntry?.data?.title || 'Biografi' } showHeaderImage={showBioHeaderImage} quotes={bioEntry?.data?.quotes || []}>
          {BioContent && <BioContent />}
        </Biography>

		<Listen title='Lyssna' skipLinkText='Hoppa över videor' playVideoLabel='Spela video' videos={videoItems} />

        <Photo title='Foto' galleryTitle='Bildgalleri' skipLinkText='Hoppa över galleri' galleryItems={galleryItems} />

        <Contact title='Kontakt' emailTitle='E-mail' phoneTitle='Telefon' />
	</main>
    <Footer navItems={navItems} />
</Layout>
